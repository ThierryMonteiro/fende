{% extends "sfc.html" %}
{% load advanced_inputs %}
{% load static %}
{% load i18n %}
{% block top_sfc %}active{% endblock %}
{% block top_management %}active{% endblock %}
{% load vnf_api %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a>{{ service.name }} Path</a></li>
{% endblock %}

{% block page_content %}
{% fende_widget location='start' title=_("Service Details") icon="fa-area-chart" %}
<div class="row">
    <div class="col-md-12">
        <h6 class="mb-4">{% trans "Service Name:" %} <span class="text-uppercase">{{ service.name }}</span></h6>
    </div>
    <div class="col-md-3">
        <p><i class="fal fa-user fa-fw"></i>{% trans "Consultant:" %} {{ service.sfc.consultant }}</p>
        <p><i class="fal fa-tags fa-fw"></i>Tags: {% for tag in service.sfc.tag.all %}{{ tag }},{% endfor %}</p>
        <p><i class="fal fa-sitemap fa-fw"></i>{% trans "Category:" %} {{ service.sfc.category }}</p>
        <p><i class="fal fa-code-branch fa-fw"></i>{% trans "Version:" %} {{ service.sfc.version }}</p>
    </div>
    <div class="col-md-9">
        <div class="row">
            <div class="col-md-6">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-memory pr-2"></i><strong>{% trans "Memory" %}:</strong> {{ descriptor.memory }}</span>
                    <span><i class="fal fa-hdd pr-2"></i><strong>{% trans "Disk" %}:</strong> {{ descriptor.disk }}</span>
                    <span><i class="fal fa-microchip pr-2"></i><strong>{% trans "CPU" %}:</strong> {{ descriptor.cpu }}</span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h3 class="text-uppercase">{{ service.name }}</h3>
                <div class="align-center border mb-5">
                    <ul class="sfc-path d-inline-block py-0 mt-4 w-100">
                        {% for vnf in sfc %}
                        <li class="d-inline-block position-relative"><span class="path-box" data-toggle="modal" data-target=".vnfs-path-{{ vnf.id }}">{{ vnf }}</span></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        {% load manager %}
        {% for vnf in sfc %}
        {% get_vnclink vnf.vnf_id vnf.infrastructure as linkvnc %}
        <div class="modal fade vnfs-path-{{ vnf.id }}" tabindex="-1" role="dialog"
        aria-labelledby="modal-vnfs-pa">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="p-5">
                    <h3 class="m-0 text-uppercase">{{ vnf }}</h3>
                    <h5>{% trans "VNF Information:" %}</h5>
                    <div class="d-xl-flex justify-content-between" id="sfc_path_actions_vnfs">
                        <a href="{% if linkvnc %}{{ linkvnc }}{% endif %}" class="btn btn-fende" {% if not linkvnc %}onclick="alert('Problem Connection');"{% else %}target="_blank"{% endif %}>
                            <i class="fas fa-terminal pr-2 fa-pulse"></i>{% trans "Console" %}
                        </a>
                        <a href="#" onClick="virtual_function('{{ vnf.vnf_id }}', '{{ vnf.vnfd_id }}', '{{ vnf.repository.repository_id }}', '{{ vnf.infrastructure }}', 'restart_vnf', msg = 'Restarting...')" class="btn btn-primary">
                            <i class="fas fa-sync-alt pr-2"></i>{% trans "Restart" %}
                        </a>
                        <a href="#" onClick="virtual_function('{{ vnf.vnf_id }}', '{{ vnf.vnfd_id }}', '{{ vnf.repository.repository_id }}', '{{ vnf.infrastructure }}', 'stop_vnf', msg = 'Stoping...')" class="btn btn-warning">
                            <i class="fas fa-power-off pr-2"></i>{% trans "Stop" %}
                        </a>
                        <a href="#" onClick="virtual_function('{{ vnf.vnf_id }}', '{{ vnf.vnfd_id }}', '{{ vnf.repository.repository_id }}', '{{ vnf.infrastructure }}', 'update', msg = 'Updating...')" class="btn btn-success">
                            <i class="fas fa-cogs pr-2"></i>{% trans "Update" %}
                        </a>
                        <a type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#myModal{{ forloop.counter }}">
                            <i class="fas fa-wrench pr-2"></i>{% trans "Resize Allocation" %}
                        </a>
                        <a data-toggle="modal" data-target="#insModal{{ forloop.counter }}" class="btn btn-outline-success"> 
                            <i class="fas fa-info-circle pr-2"></i>{% trans "Info" %}
                        </a>
                        <a href="{% url 'Marketplace:logs' vnf.vnf_id %}" class="btn btn-outline-dark">
                            <i class="fas fa-file-signature pr-2"></i>{% trans "Logs" %}
                        </a>
                        {% get_management auth vnf as has_management %}
                        <a href="{% url 'Marketplace:vnf_api' vnf.vnf_id %}" {% if not has_management %}disabled{% endif %} class="btn btn-outline-primary">
                            <i class="fas fa-cogs pr-2"></i>VNF API
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {#                RESIZE MODAL#}
    <div id="myModal{{ forloop.counter }}" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{% trans "Resize Allocation" %}</h4>
                </div>
                <div class="modal-body">
                    <form action="/marketplace/resize/{{ service.vnffg_id }}" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="sel1">{% trans "Memory" %}</label>
                            <select name="mem_size" class="form-control">
                                <option>128 MB</option>
                                <option>256 MB</option>
                                <option>512 MB</option>
                                <option>1024 MB</option>
                                <option>2048 MB</option>
                                <option>4096 MB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sel2">CPU</label>
                            <select name="num_cpus"
                            class="form-control">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sel3">{% trans "Disk" %}</label>
                        <select name="disk_size" class="form-control">
                            <option>1 GB</option>
                            <option>2 GB</option>
                            <option>4 GB</option>
                            <option>8 GB</option>
                            <option>16 GB</option>
                        </select>
                    </div>
                    <input type='hidden' name='vnf_id' value={{ vnf.vnf_id }}>
                    <input type='hidden' name='repository' value={{ vnf.repository }}>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                    data-dismiss="modal">{% trans "Close" %}</button>
                    <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{#                INFO MODAL#}
<div id="insModal{{ forloop.counter }}" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">{% trans "VNF Information" %}</h4>
            </div>
            <div class="modal-body">
                <p><strong>{% trans "IP" %}:</strong> {{ vnf.vnf_ip }}</p>
                <p><strong>{% trans "Developer" %}:</strong> {{ vnf.repository.developer }}</p>
                <p><strong>{% trans "Institution" %}:</strong> {{ vnf.repository.institution }}</p>
                <p><strong>{% trans "Version" %}:</strong> {{ vnf.repository.version }}</p>
                <p><strong>{% trans "Category" %}:</strong> {{ vnf.repository.category }}</p>
                <p><strong>{% trans "Full Description" %}:</strong> {{ vnf.repository.full_description }}</p>
                <p><strong>{% trans "Link" %}:</strong> <a href="{{ vnf.repository.link }}">{{ vnf.link }}</a></p>
                <p><strong>{% trans "Create" %}:</strong> {{ vnf.repository.create_date }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                data-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
</div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="mt-5">
            <h6>{% trans "Real Time Data" %}</h6>
        </div>
        <div class="row mt-4">
            <div class="form-group col-12 col-xl-2">
                <label>{% trans "Service:" %}</label>
                <select id="selectedVNFs" class="select2" placeholder="Tags">
                    <option selected value="{% for instance in sfc %}{{ instance.vnf_id }}{% if not forloop.last %},{% endif %}{% endfor %}">Global</option>
                    {% for instance in sfc %}
                    <option value="{{ instance.vnf_id }}">{{ instance }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-12 col-xl-2">
                <label>{% trans "Time Range (Minutes)" %}</label>
                <select id="time_range" class="select2" placeholder="Time Range">
                    <option selected value="1">1 {% trans "Minute" %}</option>
                    <option value="5">5 {% trans "Minutes" %}</option>
                    <option value="15">15 {% trans "Minutes" %}</option>
                    <option value="30">30 {% trans "Minutes" %}</option>
                    <option value="60">60 {% trans "Minutes" %}</option>
                </select>
            </div>
            <div class="form-group col-12 col-xl-2">
                <label>{% trans "Update Time (Seconds)" %}</label>
                <select id="update_time" class="select2" placeholder="Update Time">
                    <option selected value="15">15 {% trans "Seconds" %}</option>
                    <option value="30">30 {% trans "Seconds" %}</option>
                    <option value="45">45 {% trans "Seconds" %}</option>
                    <option value="60">60 {% trans "Seconds" %}</option>
                    <option value="180">180 {% trans "Seconds" %}</option>
                </select>
            </div>
            <div class="form-group col-12 col-xl-6">
                <label>{% trans "Graphs:" %}</label>
                <div class="smart-form d-flex justify-content-between justify-content-around pt-1 radio-graph">
                    <div class="custom-control custom-switch">
                        <input class="checkbox-CPU custom-control-input" id="checkbox-CPU" type="checkbox" name="CPU" checked>
                        <label class="custom-control-label" for="checkbox-CPU">{% trans "CPU" %}</label>
                    </div>
                    <div class="custom-control custom-switch">
                        <input class="checkbox-Memory custom-control-input" id="checkbox-Memory" type="checkbox" name="Memory" checked>
                        <label class="custom-control-label" for="checkbox-Memory">{% trans "Memory" %}</label>
                    </div>
                    <div class="custom-control custom-switch">
                        <input class="checkbox-Disk custom-control-input" id="checkbox-Disk" type="checkbox" name="Disk" checked>
                        <label class="custom-control-label" for="checkbox-Disk">{% trans "Disk" %}</label>
                    </div>
                    <div class="custom-control custom-switch">
                        <input class="checkbox-Network custom-control-input" id="checkbox-Network" type="checkbox" name="Network" checked>
                        <label class="custom-control-label" for="checkbox-Network">{% trans "Network" %}</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row" style="position:relative; min-height: 250px;">
    <div class="d-flex justify-content-center align-items-center" id="loader"></div>
    <div class="col-lg-6">
        <div id="CPU"></div>
    </div>
    <div class="col-lg-6">
        <div id="Memory"></div>
    </div>
    <div class="col-lg-6">
        <div id="Disk"></div>
    </div>
    <div class="col-lg-6">
        <div id="Network"></div>
    </div>
</div>
<div id="virtual_function_modal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>
<!-- CSS Loader -->
<style>
    .loader,
    .loader:after {
        border-radius: 50%;
        width: 10em;
        height: 10em;
    }
    
    .loader {
        color: black;
        margin: 60px auto;
        font-size: 10px;
        position: relative;
        text-indent: -9999em;
        border-top: 1.1em solid rgba(255, 255, 255, 0.2);
        border-right: 1.1em solid rgba(255, 255, 255, 0.2);
        border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);
        border-left: 1.1em solid #223445;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-animation: load8 1.1s infinite linear;
        animation: load8 1.1s infinite linear;
    }
    
    @-webkit-keyframes load8 {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
    
    @keyframes load8 {
        0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
    
    #loadingDiv {
        overflow: hidden;
        position: absolute;
        z-index: 1049;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #fff;
    }
</style>
{% fende_widget location='end' %}
{% endblock %}

{% block extra_footer %}
<script async defer src="/static/js/grafico/plotly-latest.min.js"></script>
<script async defer src="/static/js/grafico/graph.js"></script>
<script>
    function virtual_function(id, vnfd_id, repository_id, infra, action, msg = 'Loading') {
        wClock(msg);
        $.ajax({
            url: "/en/api/function/",
            method: "POST",
            data: {
                'vnf_id': id,
                'vnfd_id': vnfd_id,
                'repository_id': repository_id,
                'infra': infra, 'action': action, csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (resposta) {
                $('#virtual_function_modal .modal-header .modal-title').empty().append(resposta.status);
                $('#virtual_function_modal .modal-body').empty().append(resposta.text);
                $('.wait-clock-modal').modal('hide');
                $('#virtual_function_modal').modal('show');
            },
            error: function (err) {
                $('#virtual_function_modal .modal-header .modal-title').empty().append(resposta.status);
                $('#virtual_function_modal .modal-body').empty().append(resposta.text);
                $('.wait-clock-modal').modal('hide');
                $('#virtual_function_modal').modal('show');
            }
        });
    }
    
    
    /* Loading */
    $('#loader').append('<div style="" id="loadingDiv"><center class="mt-5">Carregando Gr√°ficos...</center><div class="loader">Loading...</div></div>');
    $(window).on('load', function () {
        setTimeout(removeLoader, 1500);
    });
    
    function removeLoader() {
        $("#loadingDiv").fadeOut(500, function () {
            $("#loadingDiv").remove();
        });
    }
</script>
{% endblock %}