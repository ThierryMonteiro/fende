{% extends "marketplace_base.html" %}
{% load advanced_inputs %}
{% load static %}
{% load i18n %}
{% block top_instances %}active{% endblock %}
{% block top_management %}active{% endblock %}
{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'Marketplace:instances' %}">{% trans "Instances" %}</a></li>
{% endblock %}

{% block page_content %}
{% fende_widget widget_type='no-padding' location='start' id='instances' title=_("Instances") tutorial=_("tutorial/instances.html")%}
{% if active_vnfs %}
<table id="tab1" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th data-hide="phone"><i class="fa fa-fw  fa-tags txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                {% trans "Name" %}
            </th>
            <th><i class="fa fa-fw fa-user txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                ID
            </th>
            <th><i class="fa fa-fw fa-server txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                IP
            </th>
            <th><i class="fa fa-fw fa-server txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                Status
            </th>
            <th><i class="fa fa-fw fa-server txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                {% trans "Infrastructure" %}
            </th>
            <th><i class="fa fa-fw fa-link txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                {% trans "SFC Member" %}
            </th>
            <th>
                <i class="fa fa-fw fa-calendar txt-color-blue hidden-md hidden-sm hidden-xs"></i>
                {% trans "Create Date" %}
            </th>
            <th><i class="fal fa-fw fa-tasks"></i>
                {% trans "Actions" %}
            </th>
        </tr>
    </thead>
    <tbody>
        {% for vnf in active_vnfs %}
        <tr>
            <td>{{ vnf.VNF_name }}</td>
            <td>{{ vnf.vnf_id }}</td>
            <td>{{ vnf.vnf_ip }}</td>
            <td>
                {% if vnf.status == 'true' %}
                <span class="label label-success">{% trans "RUNNING" %}</span>
                {% else %}
                <span class="label label-danger">{% trans "STOPPED" %}</span>
                {% endif %}
            </td>
            <td>{{ vnf.infrastructure }}</td>
            <td>{{ vnf.sfc_member }}</td>
            <td>{{ vnf.created_date | date:"d/m/Y H:i" }}</td>
            <td>
                <div class="btn-group">
                    <button type="button" class="btn btn-gtfende disabled">{% trans "Options" %}</button>
                    <button class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-expanded="true"><span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="#" onClick="restart_vnf('{{ vnf.vnf_id }}', '{{ vnf.sfc_member }}');" class="btn btn-primary">{% trans "Restart" %}</a>
                        </li>
                        <li>
                            <a href="#" onClick="stop_vnf('{{ vnf.vnf_id }}', '{{ vnf.sfc_member }}');" class="btn btn-warning">{% trans "Stop" %}</a>
                        </li>
                        <li>
                            <a href="#"
                            onClick="delete_vnf('{{ vnf.vnf_id }}','{{ vnf.vnfd_id }}', '{{ vnf.sfc_member }}');" class="btn btn-danger">{% trans "Delete" %}</a>
                        </li>
                        <li>
                            <a href="#"
                            onClick="update('{{ vnf.vnf_id }}', '{{ vnf.repository }}', '{{ vnf.sfc_member }}');" class="btn btn-success">{% trans "Update" %}</a>
                        </li>
                        <li>
                            <a type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal{{ forloop.counter }}">{% trans "Resize Allocation" %}</a>
                        </li>
                        <li>
                            <a data-toggle="modal" data-target="#insModal{{ forloop.counter }}" class="btn btn-info">Info</a>
                            <a href="{% url 'Marketplace:logs' vnf.vnf_id  %}" class="btn btn-gtfende">Logs</a>
                        </li>
                        <li>
                            <a href="#" onClick="vnf_statistics('{{ vnf.vnf_id }}');" class="btn btn-primary">{% trans "Statistics" %}</a>
                        </li>
                    </ul>
                </div>
            </td>
        </tr>
        <div id="myModal{{ forloop.counter }}" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">{% trans "Resize Allocation" %}</h4>
                    </div>
                    <div class="modal-body">
                        <form action="/marketplace/resize/" method="post">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="sel1">{% trans "Memory" %}</label>
                                <select name="mem_size" class="form-control">
                                    <option>128 MB</option>
                                    <option>256 MB</option>
                                    <option>512 MB</option>
                                    <option>1024 MB</option>
                                    <option>2048 MB</option>
                                    <option>4096 MB</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sel2">CPU</label>
                                <select name="num_cpus" class="form-control">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sel3">{% trans "Disk" %}</label>
                                <select name="disk_size" class="form-control">
                                    <option>1 GB</option>
                                    <option>2 GB</option>
                                    <option>4 GB</option>
                                    <option>8 GB</option>
                                    <option>16 GB</option>
                                </select>
                            </div>

                            <input type='hidden' name='vnf_id' value={{ vnf.vnf_id }}>
                            <input type='hidden' name='repository' value={{ vnf.repository }}>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
                            <button type="submit" class="btn btn-primary">{% trans "Save changes" %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </tbody>
</table>
{% else %}
{#                            todo: arrumar isso#}
<h1 style="padding-top: 30px">
    <center>{% trans "No VNF instantiated." %}</center>
</h1>
{% endif %}
{% fende_widget location='end'%}


{% for vnf in catalog %}
<div id="insModal{{ forloop.counter }}" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">{% trans "VNF Information" %}</h4>
            </div>
            <div class="modal-body">
                <p><strong>{% trans "Developer:" %}</strong> {{ vnf.developer }}</p>
                <p><strong>{% trans "Institution:" %}</strong> {{ vnf.institution }}</p>
                <p><strong>{% trans "Version:" %}</strong> {{ vnf.version }}</p>
                <p><strong>{% trans "Category:" %}</strong> {{ vnf.category }}</p>
                <p><strong>{% trans "Full Description:" %}</strong> {{ vnf.full_description }}</p>
                <p><strong>{% trans "Link:" %}</strong> <a href="{{ vnf.link }}">{{ vnf.link }}</a></p>
                <p><strong>{% trans "Create:" %}</strong> {{ vnf.create_date }}</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
var id = null

function restart_vnf(id, sfc_member) {
    warning_message = "Are you sure that you want to restart this VNF function?"

    if (sfc_member != 'None') {
        warning_message += "\n\nBe aware that this VNF is being used on SFC: "
        warning_message += sfc_member
    }

    if (confirm(warning_message)) {
        $.post("/marketplace/restart/", {
            'vnf_id': id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        function (data, status) {
            location.reload();
        });
    }
}

function stop_vnf(id, sfc_member) {
    warning_message = "Are you sure that you want to stop this VNF function?"

    if (sfc_member != 'None') {
        warning_message += "\n\nBe aware that this VNF is being used on SFC: "
        warning_message += sfc_member
    }

    if (confirm(warning_message)) {
        $.post("/marketplace/stop/", {
            'vnf_id': id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        function (data, status) {
            location.reload();
        });
    }
}

function delete_vnf(vnf_id, vnfd_id, sfc_member) {
    warning_message = "Are you sure that you want to delete this VNF function?"

    if (sfc_member != 'None') {
        warning_message += "\n\nBe aware that this VNF is being used on SFC: "
        warning_message += sfc_member
    }

    if (confirm(warning_message)) {
        $.post("/marketplace/delete/", {
            'vnf_id': vnf_id,
            'vnfd_id': vnfd_id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        function (data, status) {
            location.reload();
        });
    }
}

function update(id, repository_id, sfc_member) {
    warning_message = "Are you sure that you want to update this VNF function?"

    if (sfc_member != 'None') {
        warning_message += "\n\nBe aware that this VNF is being used on SFC: "
        warning_message += sfc_member
    }

    if (confirm(warning_message)) {
        $.post(
            "/marketplace/update/", {
                'vnf_id': id,
                'repository_id': repository_id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                location.reload();
            }
            );
    }
}

function resize_allocation(id, repository_id) {
    $.post(
        "/marketplace/resize/", {
            'vnf_id': id,
            'repository_id': repository_id,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        function (data, status) {
            location.reload();
        }
        );
}

function vnf_info(id) {
    info = window.open("/marketplace/instances/info/" + id, "", "scrollbars=no,status=no,location=no,toolbar=no,menubar=no,width=480,height=330");
}

function vnf_statistics(id) {
    window.location.replace("/marketplace/instances/statistics/" + id);
}

        /* function vnf_statistics(id) {
            $.post("/marketplace/instances/statistics/", {
                'vnf_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            });

            sleep(4000);
            location.reload();
        } */

        function sleep(milliseconds) {
            var start = new Date().getTime();
            for (var i = 0; i < 1e7; i++) {
                if ((new Date().getTime() - start) > milliseconds) {
                    break;
                }
            }
        }
        </script>

        {% endblock page_content %}
        
        <!--SCRIPT TABELAS -->
        {% block table %}
        {% fende_widget location='table' %}
        {% endblock %}
        <!--SCRIPT TABELAS -->
