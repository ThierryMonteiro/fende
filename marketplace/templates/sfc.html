{% extends "marketplace_base.html" %}
{% load advanced_inputs %}
{% load static %}
{% load i18n %}

{% block top_sfc %}active{% endblock %}
{% block top_management %}active{% endblock %}


{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'Marketplace:sfc_list' %}">SFC</a></li>
{% endblock %}

{% block page_content %}
{% fende_widget widget_type='no-padding' location='start' title=_("SFCs") tutorial=_("tutorial/sfc.html") %}

{% if sfcs %}
<table id="tab1" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th><i class="fal fa-fw fa-tags"></i>{% trans "Name" %}</th>
            <th><i class="fal fa-fw fa-server"></i>Status</th>
            <th><i class="fal fa-fw fa-server"></i>{% trans "Infrastructure" %}</th>
            <th><i class="fal fa-fw fa-calendar"></i>{% trans "Create Date" %}</th>
            <th><i class="fal fa-fw fa-tasks"></i>{% trans "Actions" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for sfc in sfcs %}
        <tr>
            <td>{{ sfc.name }}</td>
            <td class="text-center">
                {% if sfc.status == 'true' %}
                <span class="badge badge-success">{% trans "ACTIVE" %}</span>
                {% else %}
                <span class="badge badge-danger">{% trans "INACTIVE" %}</span>
                {% endif %}
            </td>
            <td>{{ sfc.infrastructure }}</td>
            <td>{{ sfc.created_date | date:"d/m/Y H:i" }}</td>
            <td>
                <div class="d-md-flex justify-content-between">
                    <a class="min-w-25" href="/marketplace/sfc/sfc_path/{{ sfc.vnffg_id }}">
                        <button type="button" class='btn btn-info btn-xs w-100'>{% trans "See" %}</button>
                    </a>
                    <div class="btn-group d-flex">
                        <button class="btn btn-xs btn-block btn-secondary dropdown-toggle min-w-25" data-toggle="dropdown" data-boundary="viewport" aria-expanded="true">
                            {% trans "Options" %}
                            <span class="caret"></span>
                        </button>
                        <div class="dropdown-menu right-0">
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'soft_restart', 'Restart');">{% trans "Soft restart" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'full_restart', 'Restart');">{% trans "Full restart" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'soft_stop', 'Stop');">{% trans "Soft stop" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'full_stop', 'Stop');">{% trans "Full stop" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'start', 'Start');">{% trans "Start" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'update', 'Update');">{% trans "Update" %}</a>
                            <a class="dropdown-item" href="#" onClick="service('{{ sfc.vnffg_id }}', '{{ sfc.infrastructure }}', 'delete_sfc', 'Delete');">{% trans "Delete" %}</a>
                            <a class="dropdown-item" data-toggle="modal" data-target="#sfcinsModal{{ forloop.counter }}">Info</a>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<h1 class="text-center">{% trans "No SFC instantiated." %}</h1>
{% endif %}

{% fende_widget location='end' %}

{% for sfc in sfcs %}
<div id="sfcinsModal{{ forloop.counter }}" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "SFC Information" %}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>{% trans "Name:" %}</strong> {{ sfc.name }}</p>
                <p><strong>{% trans "Status:" %}</strong>
                    {% if sfc.status == 'true' %}
                    <span class="badge badge-success">{% trans "ACTIVE" %}</span>
                    {% else %}
                    <span class="badge badge-danger">{% trans "INACTIVE" %}</span>
                    {% endif %}
                </p>
                <p><strong>VNFFG ID:</strong> {{ sfc.vnffg_id }}</p>
                <p><strong>VNFFGD ID:</strong> {{ sfc.vnffgd_id }}</p>
                <p><strong>{% trans "Created Date:" %}</strong> {{ sfc.created_date }}</p>
                <p><strong>{% trans "VNFs Path:" %}</strong>
                    <ul class="list-group">
                        {% for vnf_name, vnf_status in sfc.path %}
                        <li class="list-group-item">{{ vnf_name }}
                            {% if vnf_status == "ERROR" %}
                            <span class="badge badge-danger">{% trans "STOPPED" %}</span>
                            {% else %}
                            <span class="badge badge-success">{% trans "RUNNING" %}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </p>
                {% if sfc.public_port %}
                <p><strong>Public Port:</strong>{{ sfc.public_port }}</p>
                {% else %}
                <p><strong>ACL:</strong>
                    <ul class="list-group">
                        {% for criteria, value in sfc.acl %}
                        <li class="list-group-item">{{ criteria }}: {{ value }}</li>
                        {% endfor %}
                    </ul>
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock page_content %}

<!-- SCRIPTS ADICIONAIS -->
{% block extra_footer %}
<script>
    function service(id, infra, action, msg = 'Loading') {
        wClock(msg);
        $.ajax({
            url: "/en/api/service/",
            method: "POST",
            data: {
                'vnffg_id': id,
                'infra': infra, 'action': action, csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (resposta) {
                console.log('Sucess:');
                console.log(resposta);
                $('.wait-clock-modal.show .modal-content').children('.wait-text').empty().append('<h1>'+ resposta.text +'</h1><p>'+ resposta.status +'</p>');
                $('.wait-clock-modal.show .modal-content').children('.progress').hide();
                $('.wait-clock-modal.show .modal-content').append('<div class="modal-footer pb-0"><button value="Refresh Page" class="btn btn-success px-5" onClick="window.location.reload()">Confirm</button></div>');
            },
            error: function (request, status, error) {
                console.log('ERROR:');
                console.log(request);
                console.log(status);
                console.log(error);
                $('.wait-clock-modal.show .modal-content').children('wait-text').removeClass('.text-center').empty().append('<pre>'+ request.responseText +'</pre>');
                $('.wait-clock-modal.show .modal-content').children('.progress').hide();
                $('.wait-clock-modal.show .modal-content').append('<div class="modal-footer pb-0"><button value="Refresh Page" class="btn btn-danger px-5" onClick="window.location.reload()">Confirm</button></div>');
            }
        });
    }
    
    function soft_restart(id) {
        if (confirm("Are you sure that you want to soft restart this SFC?")) {
            document.getElementById('overlay').style.display = 'block';
            $.post("/marketplace/sfc/soft_restart/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function full_restart(id) {
        if (confirm("Are you sure that you want to fully restart this SFC?")) {
            $.post("/marketplace/sfc/full_restart/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function soft_stop(id) {
        if (confirm("Are you sure that you want to soft stop this SFC?")) {
            $.post("/marketplace/sfc/soft_stop/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function full_stop(id) {
        if (confirm("Are you sure that you want to fully stop this SFC?")) {
            $.post("/marketplace/sfc/full_stop/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function start(id) {
        if (confirm("Are you sure that you want to start this SFC?")) {
            $.post("/marketplace/sfc/start/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function update(id) {
        if (confirm("Are you sure that you want to update this SFC?")) {
            $.post("/marketplace/sfc/update/", {
                'vnffg_id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function (data, status) {
                sleep(4000);
                location.reload();
            });
        }
    }
    
    function sfc_path(id) {
        visualization = window.open("/marketplace/sfc/sfc_path/" + id, "", "scrollbars=no,status=no,location=no,toolbar=no,menubar=no,width=480,height=330");
        location.reload(100);
    }
    
    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds) {
                break;
            }
        }
    }
</script>
{% endblock %}
<!-- SCRIPTS ADICIONAIS -->

<!--SCRIPT TABELAS -->
{% block table %}
{% fende_widget location='table' %}
{% endblock %}
<!--SCRIPT TABELAS -->
