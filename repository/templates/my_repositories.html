{% extends "bases/dev_base.html" %}
{% load advanced_inputs %}
{% load static %}
{% load i18n %}

{% block top_manage %}active{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'Repository:dev_myrepositories' %}">{% trans "My Repositories" %}</a>
</li>
{% endblock %}

{% block page_content %}

{% fende_widget location='start' widget_type='no-padding' id='repositories' title=_("My Repositories") tutorial=_("tutorial/repositories.html") %}
<table id="tab1" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th data-hide="phone">
                <i class="fal fa-fw fa-tags"></i>
                {% trans "VNF Name" %}
            </th>
            <th data-hide="phone">
                <i class="fal fa-fw fa-exclamation-circle "></i>
                {% trans "Version" %}
            </th>
            <th data-hide="phone">
                <i class="fal fa-fw fa-exclamation-circle "></i>
                {% trans "Abstract" %}
            </th>
            <th class="hidden-xs">
                <i class="fal fa-fw fa-calendar"></i>
                {% trans "Active Since" %}
            </th>
            <th>
                <i class="fal fa-fw fa-list-alt"></i>
                {% trans "Actions" %}
            </th>
        </tr>
    </thead>
    <tbody>
        <!-- Populando a tabela com informações da tabela Requests -->
        {% for VNF in vnf_list %}
        <tr>
            <td>{{ VNF.VNF_name }}</td>
            <td>{{ VNF.version }}</td>
            <td>{{ VNF.abstract }}</td>
            <td class="hidden-xs">{{ VNF.create_date }}</td>
            <td>
                <div class="btn-group w-100">
                    <button class="btn btn-xs btn-block btn-secondary dropdown-toggle" data-toggle="dropdown"
                    aria-expanded="true">
                    {% trans "Options" %}
                    <span class="caret"></span>
                </button>
                <div class="dropdown-menu right-0">
                    {% if VNF.link == 'Package Constructor' %}
                    <a class="dropdown-item" href="{#   {% url 'Repository:download' VNF.request_id %}  #}"><i
                        class="fal fa-fw fa-link"></i>{% trans 'Access' %}</a>
                        {% else %}
                        <a class="dropdown-item" href="{{ VNF.link }}" target="_blank"><i
                            class="fal fa-fw fa-link"></i>{% trans 'Access' %}</a>
                            {% endif %}
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#PolicyModal"
                            data-id="{{ VNF.VNF_name }}-{{ VNF.version }}-{{ VNF.developer }}"
                            onClick="setPolicy();">{% trans "Change Policy" %}</a>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#VNFDModal"
                            data-id="{{ VNF.VNF_name }}-{{ VNF.version }}-{{ VNF.developer }}"
                            onClick="setVNFD();">{% trans "Update VNFD" %}</a>
                        </div>
                    </div>
                </td>
                <div id="PolicyModal" class="modal fade" role="dialog">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{% trans "Policy Update" %}</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    &times;
                                </button>
                            </div>
                            <div class="modal-body">
                                <form action="/repository/dev/policy_update/" method="post">
                                    {% csrf_token %}
                                    <div class="form-group">
                                        <label for="sel1">{% trans "Contract VNF" %}</label>
                                        <select name="contract_vnf" class="form-control">
                                            <option>{% trans "None" %}</option>
                                            <option>{% trans "All" %}</option>
                                            <option>{% trans "Specific" %}</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="sel2">{% trans "See code source" %}</label>
                                        <select name="code_source" class="form-control">
                                            <option>{% trans "None" %}</option>
                                            <option>{% trans "All" %}</option>
                                            <option>{% trans "Specific" %}</option>
                                        </select>
                                    </div>
                                    <input type='hidden' name='vnf_id'>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                data-dismiss="modal">{% trans "Close" %} </button>
                                <button type="submit" class="btn btn-primary">{% trans "Save changes" %} </button>
                            </div>
                        </div>
                    </div>
                </div>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div id="VNFDModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>{% trans "Submit a new VNFD file" %}</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="upload" action="/repository/dev/VNFD_update/" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-group">
                            {% trans "Describe the VNFD modifications" %}
                            <textarea rows="10" class="w-100" name="vnfd_comments" form="upload"> </textarea>
                            <input type="file" name="vnfd_content" id="vnfd_content" form="upload">
                        </div>
                        <input type='hidden' name='vnf_id'>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">{% trans "Close" %}</button>
                        <button type="submit" class="btn btn-primary">{% trans "Send VNFD" %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endblock page_content %}
    
    <!--SCRIPT TABELAS -->
    {% block table %}
    {% fende_widget location='table' %}
    {% endblock %}
    <!--SCRIPT TABELAS -->
    
    {% block extra_footer %}
    <script>
        // repository identifiers
        function setVNFD() {
            $('#VNFDModal').on('show.bs.modal', function (e) {
                var myRepository = $(e.relatedTarget).attr('data-id');
                $(e.currentTarget).find('input[name="vnf_id"]').val(myRepository);
            });
        }
        
        function setPolicy() {
            $('#PolicyModal').on('show.bs.modal', function (e) {
                var myRepository = $(e.relatedTarget).attr('data-id');
                $(e.currentTarget).find('input[name="vnf_id"]').val(myRepository);
            });
        }
        
        function upload(event) {
            event.preventDefault();
            var data = new FormData();
            data.append('upload', $('#vnfd_content').prop('files')[0]);
            
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: data,
                cache: false,
                processData: false,
                contentType: false,
                success: function (data) {
                    alert('success');
                }
            });
            return false;
        }
    </script>
    
    {% endblock %}
    